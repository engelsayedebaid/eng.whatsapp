<div class="message-wrapper" [class.incoming]="!message.fromMe">
  <!-- Author Avatar (for group incoming messages) -->
  @if (message.authorInfo && !message.fromMe) {
    <div class="author-avatar" (click)="openImageModal()">
      @if (message.authorInfo.profilePicUrl) {
        <img [src]="message.authorInfo.profilePicUrl" [alt]="getAuthorDisplayName()" />
      } @else {
        <span class="initials">{{ getAuthorInitials() }}</span>
      }
    </div>
  }

  <div 
    class="message-bubble" 
    [class.outgoing]="message.fromMe" 
    [class.incoming]="!message.fromMe"
    [class.with-tail]="showTail"
    [class.has-author]="message.authorInfo && !message.fromMe">
    
    @if (message.isForwarded) {
      <div class="forwarded-label">
        <svg viewBox="0 0 16 16" width="12" height="12">
          <path fill="currentColor" d="M8.5 4.5L12 8l-3.5 3.5V9H6a2 2 0 0 0-2 2v1.5H2.5v-1.5a3.5 3.5 0 0 1 3.5-3.5h2.5V4.5z"></path>
        </svg>
        <span>Forwarded</span>
      </div>
    }
    
    @if (message.quotedMsg) {
      <div class="quoted-message">
        <div class="quote-bar"></div>
        <div class="quote-content">
          <span class="quote-author">{{ message.quotedMsg.fromMe ? 'You' : 'Contact' }}</span>
          <span class="quote-text">{{ message.quotedMsg.body }}</span>
        </div>
      </div>
    }
    
    <!-- Author name for group messages -->
    @if (message.authorInfo && !message.fromMe) {
      <div class="message-author" [style.color]="getAuthorColor()">
        {{ getAuthorDisplayName() }}
      </div>
    }

    <div class="message-content">
      <!-- Media Content -->
      @if (message.hasMedia) {
        <div class="media-container" (click)="openMediaModal()">
          @if (isImage) {
            <!-- Image -->
            <div class="media-placeholder image">
              @if (mediaUrl) {
                <img [src]="mediaUrl" alt="Image" class="media-image" />
              } @else {
                <div class="media-loading-placeholder" (click)="loadMedia(); $event.stopPropagation()">
                  <svg viewBox="0 0 24 24" width="40" height="40">
                    <path fill="currentColor" d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"></path>
                  </svg>
                  @if (mediaLoading) {
                    <div class="media-spinner"></div>
                  } @else {
                    <span>Click to load</span>
                  }
                </div>
              }
            </div>
          } @else if (isVideo) {
            <!-- Video -->
            <div class="media-placeholder video">
              @if (mediaUrl) {
                <video [src]="mediaUrl" controls class="media-video"></video>
              } @else {
                <div class="media-loading-placeholder" (click)="loadMedia(); $event.stopPropagation()">
                  <svg viewBox="0 0 24 24" width="40" height="40">
                    <path fill="currentColor" d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"></path>
                  </svg>
                  @if (mediaDuration) {
                    <span class="duration">{{ mediaDuration }}</span>
                  }
                  @if (mediaLoading) {
                    <div class="media-spinner"></div>
                  } @else {
                    <span>Click to load</span>
                  }
                </div>
              }
            </div>
          } @else if (isAudio || isVoiceNote) {
            <!-- Audio / Voice Note -->
            <div class="media-placeholder audio" [class.voice-note]="isVoiceNote">
              @if (mediaUrl) {
                <audio [src]="mediaUrl" controls class="media-audio"></audio>
              } @else {
                <div class="media-loading-placeholder audio-placeholder" (click)="loadMedia(); $event.stopPropagation()">
                  <svg viewBox="0 0 24 24" width="28" height="28">
                    <path fill="currentColor" d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"></path>
                  </svg>
                  @if (mediaDuration) {
                    <span class="duration">{{ mediaDuration }}</span>
                  }
                  @if (mediaLoading) {
                    <div class="media-spinner small"></div>
                  }
                </div>
              }
            </div>
          } @else if (isDocument) {
            <!-- Document -->
            <div class="media-placeholder document" (click)="downloadMedia(); $event.stopPropagation()">
              <div class="document-icon">
                <svg viewBox="0 0 24 24" width="32" height="32">
                  <path fill="currentColor" d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path>
                </svg>
              </div>
              <div class="document-info">
                <span class="document-name">{{ mediaFilename }}</span>
                @if (mediaFilesize) {
                  <span class="document-size">{{ mediaFilesize }}</span>
                }
              </div>
              <div class="download-icon">
                <svg viewBox="0 0 24 24" width="24" height="24">
                  <path fill="currentColor" d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
                </svg>
              </div>
            </div>
          } @else if (isSticker) {
            <!-- Sticker -->
            <div class="media-placeholder sticker">
              @if (mediaUrl) {
                <img [src]="mediaUrl" alt="Sticker" class="media-sticker" />
              } @else {
                <div class="media-loading-placeholder" (click)="loadMedia(); $event.stopPropagation()">
                  <svg viewBox="0 0 24 24" width="40" height="40">
                    <path fill="currentColor" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"></path>
                  </svg>
                  @if (mediaLoading) {
                    <div class="media-spinner"></div>
                  }
                </div>
              }
            </div>
          }
          
          <!-- Caption -->
          @if (mediaCaption && mediaCaption !== message.body) {
            <div class="media-caption">{{ mediaCaption }}</div>
          }
        </div>
      }

      <!-- Text Content -->
      @if (message.body && !message.hasMedia) {
        <span class="message-text">{{ message.body }}</span>
      } @else if (message.body && message.hasMedia && !mediaCaption) {
        <span class="message-text">{{ message.body }}</span>
      }
      
      <span class="message-meta">
        <span class="message-time">{{ formattedTime }}</span>
        @if (message.fromMe) {
          <span class="message-status" [attr.data-status]="ackStatus">
            @if (message.ack === 0) {
              <!-- Pending -->
              <svg viewBox="0 0 12 11" width="12" height="11">
                <path fill="currentColor" d="M6 0a6 6 0 1 0 0 12A6 6 0 0 0 6 0zm0 10.5A4.5 4.5 0 1 1 6 1.5a4.5 4.5 0 0 1 0 9z"></path>
              </svg>
            } @else if (message.ack === 1) {
              <!-- Sent (single tick) -->
              <svg viewBox="0 0 12 11" width="12" height="11">
                <path fill="currentColor" d="M11.071.929a.5.5 0 0 1 0 .707l-7.071 7.071a.5.5 0 0 1-.707 0L.222 5.636a.5.5 0 0 1 .707-.707l2.717 2.717L10.364.929a.5.5 0 0 1 .707 0z"></path>
              </svg>
            } @else {
              <!-- Delivered/Read (double tick) -->
              <svg viewBox="0 0 16 11" width="16" height="11">
                <path fill="currentColor" d="M11.071.929a.5.5 0 0 1 .707 0l.707.707a.5.5 0 0 1 0 .707L6.414 8.414a.5.5 0 0 1-.707 0L2.636 5.343a.5.5 0 0 1 0-.707l.707-.707a.5.5 0 0 1 .707 0L6 5.879l5.071-4.95z"></path>
                <path fill="currentColor" d="M14.071.929a.5.5 0 0 1 .707 0l.707.707a.5.5 0 0 1 0 .707l-7.071 7.071a.5.5 0 0 1-.707 0l-.707-.707a.5.5 0 0 1 0-.707L14.071.929z"></path>
              </svg>
            }
          </span>
        }
      </span>
    </div>
    
    @if (message.isStarred) {
      <span class="star-icon">
        <svg viewBox="0 0 16 16" width="12" height="12">
          <path fill="currentColor" d="M8 0l2.47 5.01L16 5.81l-4 3.9.94 5.49L8 12.49l-4.94 2.71L4 9.71l-4-3.9 5.53-.8L8 0z"></path>
        </svg>
      </span>
    }
  </div>
</div>

<!-- Image Modal -->
@if (showModal) {
  <div class="image-modal-overlay" (click)="closeImageModal()">
    <div class="image-modal-content" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeImageModal()">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
        </svg>
      </button>
      <div class="modal-image-container">
        @if (message.authorInfo?.profilePicUrl) {
          <img [src]="message.authorInfo!.profilePicUrl" [alt]="getAuthorDisplayName()" />
        } @else {
          <div class="modal-no-image">
            <span class="large-initials">{{ getAuthorInitials() }}</span>
          </div>
        }
      </div>
      <div class="modal-info">
        <span class="modal-name">{{ getAuthorDisplayName() }}</span>
        <span class="modal-number">+{{ message.authorInfo?.number }}</span>
      </div>
    </div>
  </div>
}
